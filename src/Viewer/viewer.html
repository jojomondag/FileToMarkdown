<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>FileToMarkdown Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
    <!-- Common programming languages -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-csharp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-ruby.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-go.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-rust.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-xml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-php.min.js"></script>
    <script>
    class MarkdownRenderer {
        constructor(options = {}) {
            this.options = {
                highlight: true,
                ...options
            };

            // Map common language aliases to Prism language names
            this.languageMap = {
                'js': 'javascript',
                'py': 'python',
                'rb': 'ruby',
                'cs': 'csharp',
                'ts': 'typescript',
                'html': 'markup',
                'xml': 'markup',
                'cpp': 'cpp',
                'c++': 'cpp',
                'jsx': 'jsx',
                'tsx': 'tsx',
                'yml': 'yaml'
            };

            marked.setOptions({
                highlight: (code, lang) => {
                    if (!this.options.highlight) return code;
                    
                    try {
                        // Map language alias to Prism language name
                        const language = this.languageMap[lang] || lang;
                        
                        if (language && Prism.languages[language]) {
                            const highlighted = Prism.highlight(code, Prism.languages[language], language);
                            return `<div class="code-block ${language}">${highlighted}</div>`;
                        }
                        return `<div class="code-block">${code}</div>`;
                    } catch (error) {
                        console.warn('Highlighting failed:', error);
                        return `<div class="code-block">${code}</div>`;
                    }
                },
                langPrefix: 'language-',
                gfm: true,
                breaks: true,
                pedantic: false,
                smartLists: true,
                smartypants: true
            });
        }

        render(markdown) {
            try {
                const html = marked.parse(markdown);
                return html;
            } catch (error) {
                throw new Error(`Markdown rendering failed: ${error.message}`);
            }
        }

        highlightAll() {
            if (this.options.highlight && typeof Prism !== 'undefined') {
                requestAnimationFrame(() => {
                    // Find all code blocks and highlight them
                    document.querySelectorAll('pre code').forEach(block => {
                        // Get language from class (e.g., language-javascript)
                        const classes = block.className.split(' ');
                        const langClass = classes.find(c => c.startsWith('language-'));
                        if (langClass) {
                            const lang = langClass.replace('language-', '');
                            // Re-highlight with proper language
                            if (Prism.languages[lang]) {
                                block.innerHTML = Prism.highlight(
                                    block.textContent,
                                    Prism.languages[lang],
                                    lang
                                );
                            }
                        }
                    });
                });
            }
        }
    }

    // Main viewer functionality
    class FileToMarkdownViewer {
        constructor() {
            this.files = [];
            this.renderer = new MarkdownRenderer();
            this.initializeElements();
            this.setupEventListeners();
            this.restoreSidebarState();
        }

        initializeElements() {
            this.elements = {
                content: document.getElementById('c'),
                sidebar: document.querySelector('.p'),
                main: document.querySelector('.m'),
                fileList: document.getElementById('l'),
                fileInput: document.getElementById('f'),
                dropZone: document.getElementById('z'),
                toggleButton: document.getElementById('b')
            };
        }

        setupEventListeners() {
            // File input handling
            this.elements.fileInput.addEventListener('change', e => this.handleFiles(e.target.files));
            
            // Click to browse
            this.elements.dropZone.addEventListener('click', () => this.elements.fileInput.click());
            
            // Drag and drop
            ['dragover', 'dragleave', 'drop'].forEach(event => {
                this.elements.dropZone.addEventListener(event, e => {
                    e.preventDefault();
                    this.elements.dropZone.classList.toggle('d', event === 'dragover');
                    if (event === 'drop') {
                        this.handleFiles(e.dataTransfer.files);
                    }
                });
            });

            // Sidebar toggle
            this.elements.toggleButton.onclick = () => this.toggleSidebar();
            
            // Keyboard shortcut
            document.onkeydown = e => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    this.toggleSidebar();
                }
            };

            // Auto-update file list
            setInterval(() => this.files?.length && this.updateFileList(), 2000);
        }

        handleFiles(fileList) {
            const markdownFiles = Array.from(fileList).filter(file => 
                file.name.toLowerCase().endsWith('.md')
            );

            if (markdownFiles.length) {
                this.files.push(...markdownFiles);
                this.updateFileList();
                if (this.files.length === markdownFiles.length) {
                    this.loadFile(0);
                }
            } else {
                this.elements.content.innerHTML = '<p style="color:red">Please select a markdown (.md) file.</p>';
            }
        }

        loadFile(index) {
            const file = this.files[index];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => {
                const html = this.renderer.render(e.target.result);
                this.elements.content.innerHTML = html;
                this.elements.content.classList.add('viewing-markdown');
                // Highlight after content is rendered
                setTimeout(() => this.renderer.highlightAll(), 0);
            };
            reader.onerror = e => {
                this.elements.content.innerHTML = `<p style="color:red">Error reading file: ${e.target.error}</p>`;
            };
            reader.readAsText(file);
        }

        updateFileList() {
            this.elements.fileList.innerHTML = `<ul>${
                this.files.map((file, index) => `
                    <li><a href="#" onclick="viewer.loadFile(${index});return false">
                        ${file.webkitRelativePath || file.name}
                    </a></li>
                `).join('')
            }</ul>`;
        }

        toggleSidebar() {
            this.elements.sidebar.classList.toggle('h');
            this.elements.main.classList.toggle('e');
            this.elements.toggleButton.classList.toggle('n');
            localStorage.setItem('h', this.elements.sidebar.classList.contains('h'));
        }

        restoreSidebarState() {
            if (localStorage.getItem('h') === 'true') {
                this.elements.sidebar.classList.add('h');
                this.elements.main.classList.add('e');
                this.elements.toggleButton.classList.add('n');
            }
        }
    }

    // Initialize viewer
    window.onload = () => {
        window.viewer = new FileToMarkdownViewer();
    };
    </script>
    <style>
        body,#c{margin:0;background:#fff}body{font-family:-apple-system,system-ui,sans-serif;line-height:1.6;padding:0;background:#f5f5f5;min-height:100vh;display:flex}.p,.m{transition:all .3s ease}.p{width:300px;border-right:1px solid #eee;height:100vh;position:fixed;left:0;top:0;display:flex;flex-direction:column;background:#f8fafc;box-shadow:0 2px 4px rgba(0,0,0,.1)}.p.h{left:-300px}.h{display:flex;align-items:center;padding:15px;border-bottom:1px solid #eee;background:#f8fafc}.t{font-size:1.1em;font-weight:500;color:#2c3e50;margin:0;flex:1}.z{border-bottom:2px dashed #0366d6;padding:15px;text-align:center;cursor:pointer;background:#f8fafc;transition:.2s ease}.z:hover,.z.d{background:#e6f3ff}.z.d{border-color:#0255b3}.l{flex:1;overflow-y:auto;padding:15px}.l ul{list-style:none;padding:0;margin:0}.l li{margin:8px 0}.l a{color:#2c3e50;text-decoration:none;display:block;padding:8px 12px;border-radius:4px;transition:.2s ease}.l a:hover{background:#f0f4f8;color:#0366d6}.m{margin-left:300px;flex:1;padding:40px;max-width:100%}.m.e{margin-left:0}#c{max-width:1200px;margin:auto;padding:40px;border-radius:8px;word-wrap:break-word;box-shadow:0 2px 4px rgba(0,0,0,.1)}#f{display:none}.b{position:fixed;top:5px;left:255px;z-index:1000;padding:8px;background:#fff;border:1px solid #eee;border-radius:4px;color:#666;cursor:pointer;display:flex;align-items:center;justify-content:center;width:40px;height:40px;transition:.2s ease}.b.n{left:10px}.b:hover{background:#f0f4f8;color:#0366d6}pre,code{background:#f6f8fa;border-radius:6px}pre{padding:16px;overflow-x:auto;max-width:100%;border:1px solid #e1e4e8}code{font-family:SFMono-Regular,monospace;font-size:.9em;padding:.2em .4em}pre code{padding:0;background:0}table{border-collapse:collapse;width:100%;margin:1em 0;overflow-x:auto;display:block}th,td{border:1px solid #dfe2e5;padding:8px 12px;text-align:left}th{background:#f6f8fa}img{max-width:100%;height:auto;display:block;margin:1em auto}a{word-break:break-word}@media(max-width:768px){.p{transform:translateX(-100%)}.p.active{transform:translateX(0)}.m{margin-left:0;padding:20px}}@media(min-width:1920px){#c{padding:60px;max-width:1600px}}@media(min-width:3440px){#c{max-width:2000px}}
    </style>
</head>
<body>
    <button class="b" id="b"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg></button>
    <div class="p">
        <div class="h"><h1 class="t">FileToMarkdown</h1></div>
        <div class="z" id="z">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
            <p>Drop MD files here<br>or click to browse</p>
        </div>
        <div class="l" id="l"></div>
    </div>
    <div class="m">
        <div id="c">
            <h2>Welcome to FileToMarkdown Viewer</h2>
            <p>To view a markdown file:</p>
            <ul><li>Drop a markdown file onto the drop zone, or</li><li>Click the drop zone to browse for markdown files</li></ul>
        </div>
    </div>
    <input type="file" id="f" accept=".md" multiple>
</body>
</html>